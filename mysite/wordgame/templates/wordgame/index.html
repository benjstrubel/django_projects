<!doctype html>
<html lang="en">
    {% load static %}
<head>
  <meta charset="utf-8">
  <title>Generic Non-Trademarked Word Replacement Game</title>
  <meta name="description" content="html">
  <meta name="author" content="Ben">
      <!-- CSS from getbootstrap.com -->
    <!-- icons from feathericons.com/ -->
    <link rel='stylesheet' type='text/css' media='screen' href='{% static "wordgame/css/bootstrap.min.css" %}'>
    <script src='{% static "wordgame/js/recorder.js" %}'></script>
</head>
{{ blurb|json_script:"blurbtext"}}
<script type="text/javascript">
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    </script>
<script type="text/javascript">
function voteclick(button) {
    var formval = document.getElementById("vote");
    console.log(button.value);
    formval.value = button.value;
}

function createRGBFromScore(score) {
    var inv = 1 - score;
    var c= Math.ceil(inv * 255).toString();
    return "rgb(" + c + "," + c + "," + c + ")";
}

function setAScoreVectorColor(name) {
    var td = document.getElementById(name);
    var score = td.getAttribute("data-score");
    console.log(score);
    rgb = createRGBFromScore(score)
    td.setAttribute("style", "color: " + rgb + ";");
}

function setScoreVectorColors() {
    setAScoreVectorColor("ev");
    setAScoreVectorColor("hv");
    setAScoreVectorColor("pv");
    setAScoreVectorColor("sv");
    setAScoreVectorColor("tv");
}

function showCreation() {
    var sent = "";
    const textlist = JSON.parse(document.getElementById("blurbtext").textContent);
    for(var i = 0; i < textlist.length; ++ i) {
        if (textlist[i] == "%%%") {
            sent += document.getElementById("input" + i.toString()).value.toString();
        }
        else {
            sent += textlist[i];
        }
        sent += " ";
    }
    console.log(sent);
    e = document.getElementById("creationText");
    e.innerHTML = "<h5>" + sent + "</h5>";

    e = document.getElementById("showCreationToggle");
    e.setAttribute("style","display:block");

    e = document.getElementById("userInputToggle");
    e.setAttribute("style", "display:None");
}
</script>
<style>
    /* HIDE RADIO */
[type=radio] { 
  position: absolute;
  opacity: 0;
  width: 0;
  height: 0;
}

/* IMAGE STYLES */
[type=radio] + img {
  cursor: pointer;
  border: 1px solid transparent;
  padding: 0.375rem 0.75rem;
  font-size: 1rem;
  line-height: 1.5;
  border-radius: 0.25rem;
}

/* CHECKED STYLES */
[type=radio]:checked + img {
  background-color: #0074d9;
  }
</style>

<body onload="setScoreVectorColors()">
    {{ blurb }}
    <div class="container" id="heading">
    <h1 class="text-primary">Generic Non-Trademarked Word Replacement Game*</h1>
    <h5>Now with machine learning and a British accent!</h5>
    <br>
    </div>
    <div class="container" id="scorebar">
    <table class="table table-bordered">
        <thead>
        <tbody>
            <tr>
                <td id="ev" data-score="{{ scorevector.entertainment}}">Entertainment</td>
                <td id="hv" data-score="{{ scorevector.health}}">Health</td>
                <td id="pv" data-score="{{ scorevector.politics}}">Politics</td>
                <td id="sv" data-score="{{ scorevector.sports}}">Sports</td>
                <td id="tv" data-score="{{ scorevector.tech}}">Technology</td>
            </tr>
        </tbody>
</table>
<br>
</div>
<div id="userInputToggle">
<div class="container" id="userinput">
    <h5>Fill in your words for the parts of speech below</h5>
    <table class="table table-borderless">
        <thead>
            <tr>
                <th>Part of Speech</th>
                <th>Your Word</th>
            </tr>
        </thead>
        <tbody>
            {% for word,pos in blurbzip %}
            {% if word == "%%%" %}
            <tr>
                <td>
            {{pos}}
              </td>
              <td>
              <input type="text" id="input{{forloop.counter0 }}">
              </td>
              </tr>
            {% endif %}
            {% endfor %}
    </tbody>
    </table>
    <h5>Ready for the big reveal?</h5>
    <button id=seeIt class="btn btn-secondary" onClick="showCreation()">Let Me See It.</button>
    <button id="sayIt" class="btn btn-secondary">Read It To Me!</button>
    <br><br>   
</div>
<!-- ending div for userinput toggle-->
</div>

<!-- begin finished creation content-->
<div id="showCreationToggle" style="display: None">
<div class="container " id="creation">
    <h3 class="text-primary">Here's What You Created...</h3>
    <div id="creationText"></div>
</div>
<div class="container" id="audio">
</div>
<div class="container" id="feedback">
        <div>
            <label>
                <input type="radio" name="test" value="1" onclick="voteclick(this);" unchecked>
                <img src='{% static "wordgame/images/thumbs-up.svg" %}'>
              </label>
              <label>
                <input type="radio" name="test" value="0" onclick="voteclick(this);" unchecked>
                <img src='{% static "wordgame/images/thumbs-down.svg" %}'>
              </label>
              <br>
              <br>
        </div>

    <div class="row">
        <div class="col-sm-8">
<h5 class="text-primary">Ready To Play Again? Here Are Your Options...</h5>
We can get you a stored headline from the database that matches your preferences, a current headline, or a random local headline.
        <form action="{% url 'vote' %}" method='POST'>
            {% csrf_token %}
            <input type="hidden" name="sv" id="score_vector" value="{{scorevector}}">
            <input type="hidden" name="vote" id="vote" value ="-1">
                <button type="submit" id="default" name="default" class="btn btn-primary">Stored Headline</button>
                <button type="submit" id="current" name="current" class="btn btn-primary">Current Headline</button>
                <button type="submit" id="local" name="local" class="btn btn-primary">Local Headline</button>
        
            </form>

        </div>
        <div class="col-sm-4">
            <h5 class="text-primary">Or Tell Me A Topic You Like</h5>
            Click the microphone, wait for the message box prompt and then say a topic you like. Click the stop button when you're done.<br>
            <button onclick="startRecording(this);" id="startRecord" name="startRecord" class="btn btn-outline-primary"><img src='{% static "wordgame/images/mic.svg" %}'></button>
            <button onclick="stopRecording(this);" id="stopRecord" name="stopRecord" class="btn btn-outline-primary"><img src='{% static "wordgame/images/stop-circle.svg" %}'></button>           
        </div>
      </div>
      
</div>
<!-- end div tag for showCreation-->
</div>
<div class="container" id="bottom">
    <br>
    <p class="text text-secondary">
    *WARNING: Pregnant women, the elderly, and children under 10 should avoid prolonged exposure to Generic Word Game. Generic Word Game contains an unstable articifical intelligence core, which, if exposed due to rupture, should not be touched, inhaled, or looked at. Discontinue use of Generic Word Game if any of the following occurs: itching, vertigo, dizziness, tingling in extremities, loss of balance, slurred speech, temporary blindness, profuse sweating, or heart palpitations. If Generic Word Game begins to smoke, get away immediately. Seek shelter and cover head. When not in use the artificial intelligence core should be kept in it's special container and kept under refrigeration. Some ingredients are unknown. Do not taunt Generic Word Game. Generic Word Game comes with a lifetime warranty.
</p>
</div>
<script>
          var rec;
      var gumStream;

      function startRecording(button) {
      var constraints = {audio:true,video:false}
      navigator.mediaDevices.getUserMedia(constraints).then(function(stream) {
      console.log("got promise, initializing and recording...");
      audioContext = new AudioContext();
      gumStream = stream;
      input = audioContext.createMediaStreamSource(stream);
      rec = new Recorder(input, {numChannels:1})
      rec.record()
      console.log("recording has started...")
      });
  }

  function stopRecording(button) {
      console.log("stop button clicked");
      rec.stop();
      gumStream.getAudioTracks()[0].stop();
      rec.exportWAV(postToServer);
  }

    function postToServer(blob) {
        console.log(blob.size);
      console.log(blob.type);

      let data = new FormData;
    data.append("audioRecording", blob);

         fetch("/wordgame/audio/", {method:"POST",
         body:data,
        credentials:'same-origin', }).then(response =>
        {
            if(response.status == "200") {
                console.log("200");
                location.href = '/wordgame/custom';
            }
            else {
                console.log("error");
            }
        }
        )

        }
</script>
</body>
</html>